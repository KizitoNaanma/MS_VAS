FROM node:20.12.2-alpine3.19

ENV NODE_ENV=development
# Set empty DATABASE_URL for build time
ENV DATABASE_URL=""

WORKDIR /usr/src/app

# Copy package files
COPY package.json yarn.lock ./

# Install all dependencies (including devDependencies)
RUN yarn install --frozen-lockfile

# Copy entrypoint script
COPY entrypoint.sh /entrypoint.sh
RUN chmod +x /entrypoint.sh

# Copy source files
COPY . .

# Generate Prisma types only (no engine needed during build)
RUN yarn run schema:generate:types

# Set correct permissions
COPY entrypoint.sh /entrypoint.sh
RUN chmod +x /entrypoint.sh

RUN chown -R node:node /usr/src/app && \
    chown node:node /entrypoint.sh

USER node

EXPOSE 4000

ENTRYPOINT ["/entrypoint.sh"]
CMD ["yarn", "start:dev"]